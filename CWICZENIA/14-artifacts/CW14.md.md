
# Practical Exercise 17 - Working with Artifacts / Ćwiczenie praktyczne 17 – Praca z artefaktami

---

## **English Version**

### Exercise Description

In this practical exercise, our goal is to explore how we can leverage artifacts to share build outputs between jobs.  
We will also explore how to combine caching and artifacts in the same workflow.

In order to achieve that, we will leverage a React application that we will scaffold with the help of the `create-react-app` utility.  
Check the tips section for the specific command to scaffold your React application.  
Here are the instructions for the exercise:

1. **Generate a React application:**  
   a. Create a new folder named `14-artifacts` at the root of the repository.  
   b. Using a terminal, navigate into this directory and scaffold a React application inside a `react-app` directory.  
      You can either create the directory yourself or let the `create-react-app` utility do it for you.  
   c. Once the React setup is done, you should see a success message.  
   d. Take a few moments to inspect the files and get familiar with the application folder structure.  

2. **Create the first version of the workflow:**  
   a. Create a file named `14-artifacts.yaml` under the `.github/workflows` folder at the root of your repository.  
   b. Name the workflow `14 – Working with Artifacts`.  
   c. Add the following trigger to your workflow:  
      i. `workflow_dispatch`  
   d. Add a job named `test-build` to the workflow:  
      i. The job should run on `ubuntu-latest`.  
      ii. The job should set `14-artifacts/react-app` as the default `working-directory` for `run` commands.  
      iii. The job should contain seven steps:  
         i. **Checkout code** – checkout the repository code.  
         ii. **Setup Node** – setup Node with version `20.x`.  
         iii. **Download cached dependencies** –  
             - Have an id of `cache`.  
             - Use the `actions/cache@v3` action.  
             - Pass inputs:  
               - Key:  
                 ```yaml
                 deps-node-modules-${{ hashFiles('14-artifacts/react-app/package-lock.json') }}
                 ```  
               - Path: `14-artifacts/react-app/node_modules`.  
         iv. **Install dependencies** – run `npm ci`, executed only if no cache hit occurred.  
         v. **Unit tests** – run `npm run test`.  
         vi. **Build code** – run `npm run build`.  
         vii. **Upload build files** –  
             - Use `actions/upload-artifact@v4`.  
             - Pass inputs:  
               - `name`: `app`  
               - `path`: `14-artifacts/react-app/build`.  
   e. Add a job named `deploy` to the workflow:  
      i. Run on `ubuntu-latest`.  
      ii. Add dependency on the `test-build` job.  
      iii. Contain two steps:  
         i. **Download build files** –  
            - Use `actions/download-artifact@v4`.  
            - Inputs:  
              - `name`: `app`  
              - `path`: `build`.  
         ii. **Show folder structure** – run the command:  
            ```bash
            ls -R
            ```  

3. **Commit the changes and push the code.**  
   Trigger the workflow manually and inspect the results.  
   Can you find and download the uploaded artifacts manually? How do they look?  

4. **Extend the workflow to upload test coverage reports as artifacts:**  
   a. Replace the hard-coded `name` inputs from `upload-artifact` and `download-artifact` with a workflow-level env variable named `build-artifact-key`, value:  
      ```yaml
      app-${{ github.sha }}
      ```  
   b. Add another env variable named `test-coverage-key`, value:  
      ```yaml
      test-coverage-${{ github.sha }}
      ```  
   c. Change the **Unit tests** step to generate a coverage report.  
   d. Add another step after **Unit tests** named **Upload test results**:  
      i. Upload the contents of `14-artifacts/react-app/coverage` using the `test-coverage-key` as the artifact name.  
   e. Commit the changes and push the code. Trigger the workflow manually and inspect the results.

---

### Tips

**Generate a coverage report for unit tests with Jest**

To generate a coverage report when using Jest, pass the `--coverage` flag to the Jest command.  
When using npm, you need an extra `--` before the flag, because it must be passed to Jest, not npm.  
The correct command is:
```bash
npm run test -- --coverage
```

---

## **Wersja polska**

### Opis ćwiczenia

W tym ćwiczeniu praktycznym naszym celem jest poznanie, jak wykorzystywać artefakty do udostępniania wyników budowania pomiędzy zadaniami.  
Poznamy też sposób połączenia buforowania (caching) i artefaktów w jednym workflow.

Aby to osiągnąć, wykorzystamy aplikację React, którą stworzymy przy użyciu narzędzia `create-react-app`.  
W sekcji „Porady” znajdziesz odpowiednie polecenie.  
Instrukcje do ćwiczenia:

1. **Wygeneruj aplikację React:**  
   a. Utwórz folder `14-artifacts` w katalogu głównym repozytorium.  
   b. W terminalu przejdź do tego folderu i utwórz aplikację React w katalogu `react-app`.  
      Możesz utworzyć folder samodzielnie lub pozwolić narzędziu `create-react-app` zrobić to za Ciebie.  
   c. Po zakończeniu konfiguracji Reacta powinien pojawić się komunikat o powodzeniu.  
   d. Zapoznaj się ze strukturą folderów aplikacji.  

2. **Utwórz pierwszą wersję workflow:**  
   a. Utwórz plik `14-artifacts.yaml` w folderze `.github/workflows`.  
   b. Nazwij workflow `14 – Working with Artifacts`.  
   c. Dodaj wyzwalacz `workflow_dispatch`.  
   d. Dodaj zadanie `test-build`:  
      i. Działa na `ubuntu-latest`.  
      ii. Ustawia `14-artifacts/react-app` jako domyślny katalog roboczy (`working-directory`).  
      iii. Zawiera siedem kroków:  
         i. **Checkout code** – pobiera kod repozytorium.  
         ii. **Setup Node** – ustawia wersję `20.x`.  
         iii. **Download cached dependencies** –  
             - Id: `cache`.  
             - Akcja: `actions/cache@v3`.  
             - Klucz:  
               ```yaml
               deps-node-modules-${{ hashFiles('14-artifacts/react-app/package-lock.json') }}
               ```  
             - Ścieżka: `14-artifacts/react-app/node_modules`.  
         iv. **Install dependencies** – wykonuje `npm ci`, tylko jeśli nie znaleziono cache’a.  
         v. **Unit tests** – uruchamia `npm run test`.  
         vi. **Build code** – uruchamia `npm run build`.  
         vii. **Upload build files** –  
             - Akcja: `actions/upload-artifact@v4`.  
             - Parametry: `name: app`, `path: 14-artifacts/react-app/build`.  
   e. Dodaj zadanie `deploy`:  
      i. Uruchamiane na `ubuntu-latest`.  
      ii. Zależne od `test-build`.  
      iii. Dwa kroki:  
         i. **Download build files** –  
            - Akcja: `actions/download-artifact@v4`.  
            - Parametry: `name: app`, `path: build`.  
         ii. **Show folder structure** – uruchamia polecenie:  
            ```bash
            ls -R
            ```  

3. **Zatwierdź zmiany i wypchnij kod.**  
   Uruchom workflow ręcznie i sprawdź wyniki.  
   Czy potrafisz znaleźć i pobrać artefakty? Jak wyglądają?  

4. **Rozszerz workflow o przesyłanie raportów pokrycia testów jako artefaktów:**  
   a. Zamień stałe wartości `name` w akcjach `upload-artifact` i `download-artifact` na zmienną środowiskową `build-artifact-key`:  
      ```yaml
      app-${{ github.sha }}
      ```  
   b. Dodaj drugą zmienną środowiskową `test-coverage-key`:  
      ```yaml
      test-coverage-${{ github.sha }}
      ```  
   c. Zmień krok **Unit tests**, aby generował raport pokrycia testów.  
   d. Dodaj krok **Upload test results**, który przesyła zawartość folderu `14-artifacts/react-app/coverage` jako artefakt z nazwą `test-coverage-key`.  
   e. Zatwierdź zmiany i uruchom workflow ręcznie, aby przeanalizować wyniki.

---

### Porady

**Generowanie raportu pokrycia testów w Jest**

Aby wygenerować raport pokrycia przy użyciu Jest, dodaj flagę `--coverage`.  
Używając npm, należy dodać dodatkowe `--`, aby przekazać flagę do polecenia Jest.  
Poprawna komenda to:  
```bash
npm run test -- --coverage
```

---
