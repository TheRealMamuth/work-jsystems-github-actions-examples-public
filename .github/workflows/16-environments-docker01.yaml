name: Docker matrix build / test / push (env + registries)

on:
  push:
    branches:
      - main
      - master
  pull_request:

# Globalne ustawienia dla wszystkich kroków run:
defaults:
  run:
    shell: bash
    working-directory: ./CWICZENIA/16-environments/docker01

env:
  IMAGE_NAME: github-action-test
  DOCKERHUB_REPO: piotrskoska/github-action-test

# ===================== JOB 1: BUILD (dev + staging) ======================
jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - environment: development
            app_env: dev
            image_tag: dev
          - environment: staging
            app_env: staging
            image_tag: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show build matrix entry
        run: |
          echo "BUILD for environment: ${{ matrix.environment }}"
          echo "APP_ENV: ${{ matrix.app_env }}"
          echo "IMAGE_TAG: ${{ matrix.image_tag }}"

      - name: Build Docker image
        run: |
          docker build \
            --build-arg APP_ENV="${{ matrix.app_env }}" \
            -t "${IMAGE_NAME}:${{ matrix.image_tag }}" .

      - name: Save image as tar (artifact)
        run: |
          docker save "${IMAGE_NAME}:${{ matrix.image_tag }}" -o image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.environment }}
          # ścieżka względem root repo (NIE working-directory)
          path: ./CWICZENIA/16-environments/docker01/image.tar

# ===================== JOB 2: TEST (dev + staging) =======================
  test:
    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        include:
          - environment: development
            app_env: dev
            image_tag: dev
          - environment: staging
            app_env: staging
            image_tag: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.environment }}
          path: ./CWICZENIA/16-environments/docker01

      - name: Load Docker image from artifact
        run: |
          ls -l
          docker load -i image.tar

      - name: Test Docker image
        run: |
          echo "Testing image ${IMAGE_NAME}:${{ matrix.image_tag }} for env ${{ matrix.environment }}"

          OUTPUT="$(docker run --rm "${IMAGE_NAME}:${{ matrix.image_tag }}")"
          EXPECTED="Hello from environment: ${{ matrix.app_env }}"

          echo "Container output: $OUTPUT"
          if [[ "$OUTPUT" != "$EXPECTED" ]]; then
            echo "❌ TEST FAILED"
            exit 1
          fi

          echo "✅ TEST PASSED"

# ===================== JOB 3: PUSH dev + staging (GHCR) ==================
  push-nonprod:
    runs-on: ubuntu-latest
    needs: test

    strategy:
      matrix:
        include:
          - environment: development
            app_env: dev
            image_tag: dev
          - environment: staging
            app_env: staging
            image_tag: staging

    # używamy GitHub Environments: development / staging
    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.environment }}
          path: ./CWICZENIA/16-environments/docker01

      - name: Load Docker image from artifact
        run: |
          docker load -i image.tar

      - name: Compute FULL_IMAGE for GHCR
        run: |
          OWNER="${{ github.repository_owner }}"
          OWNER_LC=$(echo "$OWNER" | tr '[:upper:]' '[:lower:]')

          FULL_IMAGE="ghcr.io/${OWNER_LC}/${IMAGE_NAME}:${{ matrix.image_tag }}"
          echo "FULL_IMAGE=$FULL_IMAGE" >> "$GITHUB_ENV"
          echo "Full image (GHCR): $FULL_IMAGE"

      - name: Login to GitHub Container Registry (GHCR) using GITHUB_TOKEN
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Tag and push image to GHCR
        run: |
          echo "Tagging ${IMAGE_NAME}:${{ matrix.image_tag }} -> $FULL_IMAGE"
          docker tag "${IMAGE_NAME}:${{ matrix.image_tag }}" "$FULL_IMAGE"
          echo "Pushing $FULL_IMAGE"
          docker push "$FULL_IMAGE"

# ===================== JOB 4: PRODUCTION (Docker Hub) ====================
  production:
    runs-on: ubuntu-latest
    # wystartuje dopiero, gdy WSZYSTKIE matrixy jobu "test" przejdą (dev + staging)
    needs: test
    environment: production

    env:
      APP_ENV: prod
      IMAGE_TAG: latest   # tag w Docker Hub: piotrskoska/github-action-test:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build production image
        run: |
          docker build \
            --build-arg APP_ENV="${APP_ENV}" \
            -t "${IMAGE_NAME}:${IMAGE_TAG}" .

      - name: Test production image
        run: |
          echo "Testing production image ${IMAGE_NAME}:${IMAGE_TAG}"

          OUTPUT="$(docker run --rm "${IMAGE_NAME}:${IMAGE_TAG}")"
          EXPECTED="Hello from environment: ${APP_ENV}"

          echo "Container output: $OUTPUT"
          if [[ "$OUTPUT" != "$EXPECTED" ]]; then
            echo "❌ PROD TEST FAILED"
            exit 1
          fi

          echo "✅ PROD TEST PASSED"

      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "piotrskoska" --password-stdin

      - name: Compute FULL_IMAGE for Docker Hub
        run: |
          FULL_IMAGE="${DOCKERHUB_REPO}:${IMAGE_TAG}"
          echo "FULL_IMAGE=$FULL_IMAGE" >> "$GITHUB_ENV"
          echo "Prod image: $FULL_IMAGE"

      - name: Tag and push production image
        run: |
          echo "Tagging ${IMAGE_NAME}:${IMAGE_TAG} -> $FULL_IMAGE"
          docker tag "${IMAGE_NAME}:${IMAGE_TAG}" "$FULL_IMAGE"
          echo "Pushing $FULL_IMAGE"
          docker push "$FULL_IMAGE"
